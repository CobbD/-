<!DOCTYPE html>
<html>
<head>
<!-- 2016-03-28 一 12:09 -->
<meta  charset="utf-8">
<meta  name="viewport" content="width=device-width, initial-scale=1">
<title>lxml模块</title>
<meta  name="generator" content="Org-mode">
<meta  name="author" content="万泽">
<meta  name="description" content="制作者邮箱：a358003542@gmail.com"
>
<style type="text/css">
body {

}
@media (min-width: 768px) {
  body {
    width: 732px;
    padding-right: 20px;
    padding-left: 20px;
    margin-right: auto;
    margin-left: auto;
  }
}
@media (min-width: 992px) {
  body {
    width: 880px;
    padding-right: 100px;
    padding-left: 100px;
    margin-right: auto;
    margin-left: auto;
  }
}
@media (min-width: 1200px) {
  body {
    width: 750px;
    padding-right: 200px;
    padding-left: 200px;
    margin-right: auto;
    margin-left: auto;
  }
}

.title {
    display: block;
    text-align: center;
    padding: 10px;
}

.center-block {
    display: block;
    margin-left: auto;
    margin-right: auto;
}

.underline{
    text-decoration: underline;
}
   #content {
    display: block;
    margin-left: auto;
    margin-right: auto;
}

code {
    padding: 2px 4px;
    color: #c7254e;
    background-color: #f9f2f4;
    border-radius: 4px;
}

pre {
    max-width: 100%;
    display: block;
    padding: 9.5px;
    margin: 0 0 10px;
    font-size: 13px;
    line-height: 1.42857143;
    color: #333;
    background-color: #f5f5f5;
    border: 1px solid #ccc;
    border-radius: 4px;
    overflow : auto;
}


blockquote {
    padding: 10px 20px;
    margin: 0 0 20px;
    font-size: 17.5px;
    border-left: 5px solid #eee;
}


p{
    text-indent:2em;
    line-height:150%;
}

li, dt{
    margin-top: 0.5em;
    margin-bottom: 0.5em;
}

video{
    max-width: 100%;
    margin-left: auto;
    margin-right: auto;
}

figure p{
    text-indent:0em;
}
img{
    max-width: 100%;
}

embed{
    max-width: 100%;
    margin-left: auto;
    margin-right: auto;
}

figure{
    text-align: center;
}

/*  class  */
.FRAMED{
    max-width:100%;
    border:1px solid ;
    padding: 1em;
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box;
}

.NOTECARD{
    width: 30%;
    position:relative;
    right: -30%;
    padding: 1em;
    margin:0 auto;
    border: solid 1px;
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box;
}

/*
table
*/
table {
    border-collapse: collapse;
    border-spacing: 0;
    margin: 16px 0;
    empty-cells: show;
    border: 1px solid #ccc;
    width: 100%;
    display: table;
}

table tr {
    border-bottom: 1px solid #ddd;
}
table th,table td{
    padding:8px;
}

table tr:nth-child(even) {
    background-color: #f1f1f1;
}
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #8f5902; font-style: italic } /* Comment */
.highlight .err { color: #a40000; border: 1px solid #ef2929 } /* Error */
.highlight .g { color: #000000 } /* Generic */
.highlight .k { color: #204a87; font-weight: bold } /* Keyword */
.highlight .l { color: #000000 } /* Literal */
.highlight .n { color: #000000 } /* Name */
.highlight .o { color: #ce5c00; font-weight: bold } /* Operator */
.highlight .x { color: #000000 } /* Other */
.highlight .p { color: #000000; font-weight: bold } /* Punctuation */
.highlight .ch { color: #8f5902; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #8f5902; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #8f5902; font-style: italic } /* Comment.Preproc */
.highlight .cpf { color: #8f5902; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #8f5902; font-style: italic } /* Comment.Single */
.highlight .cs { color: #8f5902; font-style: italic } /* Comment.Special */
.highlight .gd { color: #a40000 } /* Generic.Deleted */
.highlight .ge { color: #000000; font-style: italic } /* Generic.Emph */
.highlight .gr { color: #ef2929 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #000000; font-style: italic } /* Generic.Output */
.highlight .gp { color: #8f5902 } /* Generic.Prompt */
.highlight .gs { color: #000000; font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #a40000; font-weight: bold } /* Generic.Traceback */
.highlight .kc { color: #204a87; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #204a87; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #204a87; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #204a87; font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: #204a87; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #204a87; font-weight: bold } /* Keyword.Type */
.highlight .ld { color: #000000 } /* Literal.Date */
.highlight .m { color: #0000cf; font-weight: bold } /* Literal.Number */
.highlight .s { color: #4e9a06 } /* Literal.String */
.highlight .na { color: #c4a000 } /* Name.Attribute */
.highlight .nb { color: #204a87 } /* Name.Builtin */
.highlight .nc { color: #000000 } /* Name.Class */
.highlight .no { color: #000000 } /* Name.Constant */
.highlight .nd { color: #5c35cc; font-weight: bold } /* Name.Decorator */
.highlight .ni { color: #ce5c00 } /* Name.Entity */
.highlight .ne { color: #cc0000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #000000 } /* Name.Function */
.highlight .nl { color: #f57900 } /* Name.Label */
.highlight .nn { color: #000000 } /* Name.Namespace */
.highlight .nx { color: #000000 } /* Name.Other */
.highlight .py { color: #000000 } /* Name.Property */
.highlight .nt { color: #204a87; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #000000 } /* Name.Variable */
.highlight .ow { color: #204a87; font-weight: bold } /* Operator.Word */
.highlight .w { color: #f8f8f8; text-decoration: underline } /* Text.Whitespace */
.highlight .mb { color: #0000cf; font-weight: bold } /* Literal.Number.Bin */
.highlight .mf { color: #0000cf; font-weight: bold } /* Literal.Number.Float */
.highlight .mh { color: #0000cf; font-weight: bold } /* Literal.Number.Hex */
.highlight .mi { color: #0000cf; font-weight: bold } /* Literal.Number.Integer */
.highlight .mo { color: #0000cf; font-weight: bold } /* Literal.Number.Oct */
.highlight .sb { color: #4e9a06 } /* Literal.String.Backtick */
.highlight .sc { color: #4e9a06 } /* Literal.String.Char */
.highlight .sd { color: #8f5902; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #4e9a06 } /* Literal.String.Double */
.highlight .se { color: #4e9a06 } /* Literal.String.Escape */
.highlight .sh { color: #4e9a06 } /* Literal.String.Heredoc */
.highlight .si { color: #4e9a06 } /* Literal.String.Interpol */
.highlight .sx { color: #4e9a06 } /* Literal.String.Other */
.highlight .sr { color: #4e9a06 } /* Literal.String.Regex */
.highlight .s1 { color: #4e9a06 } /* Literal.String.Single */
.highlight .ss { color: #4e9a06 } /* Literal.String.Symbol */
.highlight .bp { color: #3465a4 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #000000 } /* Name.Variable.Class */
.highlight .vg { color: #000000 } /* Name.Variable.Global */
.highlight .vi { color: #000000 } /* Name.Variable.Instance */
.highlight .il { color: #0000cf; font-weight: bold } /* Literal.Number.Integer.Long */
</style>
</head>
<body>
<div id="content">
<header>
<h1 class="title">lxml模块</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgheadline1">1. 安装</a></li>
<li><a href="#orgheadline2">2. xml文档结构</a></li>
<li><a href="#orgheadline5">3. 往里面加入内容</a>
<ul>
<li><a href="#orgheadline3">3.1. Element类</a></li>
<li><a href="#orgheadline4">3.2. SubElement类</a></li>
</ul>
</li>
<li><a href="#orgheadline6">4. 参考资料</a></li>
</ul>
</div>
</nav>


<div class="outline-2">
<h2 id="orgheadline1">安装</h2>
<div class="outline-text-2" id="text-1">
<p>
首先确认你的系统已经安装了如下软件包：
</p>
<div class="highlight"><pre><span></span>sudo apt-get install libxml2-dev libxslt-dev python-dev
</pre></div>

<p>
如果你使用的python3，那么确认安装了python3-dev。
</p>

<p>
然后推荐用pip安装lxml：
</p>
<div class="highlight"><pre><span></span>sudo pip install lxml
</pre></div>

<p>
如果你使用的python3，那么用 <strong>pip3</strong> 命令来安装。
</p>
</div>
</div>


<div class="outline-2">
<h2 id="orgheadline2">xml文档结构</h2>
<div class="outline-text-2" id="text-2">
<p>
这点参考资料 <a href="#orgtarget1">1</a> 第二节介绍的比较好。不管html还是xhtml等，其都属于xml文档系，理论上lxml模块是能够处理所有的xml系文档的，不过下面的讨论只局限于html5文档。对于xml文档概念不熟悉的读者请简单看一下维基百科参考资料 <a href="#orgtarget2">2</a> 即可。
</p>

<p>
下面是一个简单的html5文档样例：
</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span>  <span class="na">href</span><span class="o">=</span><span class="s">&quot;main.css&quot;</span><span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>your awesome website<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">header</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>your awesome title<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">header</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>

<p>
这里不会深入讨论html文档的概念，而直接进入lxml模块的学习。
</p>

<p>
一般使用
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
</pre></div>

<p>
然后使用etree子模块的parse某个html文档:
</p>
<div class="highlight"><pre><span></span><span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">)</span>
</pre></div>

<p>
这个tree数据结构如下图所示（图片来源<a href="http://www.w3schools.com/">w3schools</a>）
</p>


<figure>
<p><img src="images/htmltree.png" alt="htmltree.png">
</p>
<figcaption><span class="figure-number">Figure 1:</span> htmltree</figcaption>
</figure>

<p>
其中tree变量很重要的一个方法是 <strong>getroot</strong> ：
</p>
<div class="highlight"><pre><span></span><span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
</pre></div>

<p>
这个root变量对应的正是上图的Root Element。这里需要说一下，lxml模块将html文档里面的各个标签，也就是上图的Root下面的方框Element都视作Node，父元素和子元素之间是列表包含关系。你可以用 <code>root[0]</code> ， <code>root[1]</code> 来查看一下。
</p>

<p>
其对应的就是head元素和body元素，可用python数据结构如下近似表示之：
</p>
<pre>
root[head[meta[], link[], title[]], body[head[]...]...]
</pre>

<p>
然后每一个元素都有很多属性，比如 <strong>tag</strong> 存储这个元素（标签）的名字， <strong>text</strong> 存储这个元素标签包围着的文本内容，比如
</p>
<pre>
&lt;title&gt;your awesome title&lt;/title&gt;
</pre>
<p>
这里title这个元素的 <strong>text</strong> 就是文本：your awesome title。 还有一个 <strong>tail</strong> 属性似乎没什么用处。
</p>

<p>
然后还有一个很重要的属性 <strong>attrib</strong> ，其对应的就是该元素标签的属性，是一个字典值： 
</p>
<div class="highlight"><pre><span></span><span class="n">attr</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">attrib</span>
</pre></div>

<p>
比如上面的link元素可以近似如下表示：
</p>
<pre>
link[{'rel':'stylesheet', 'href':'main.css'}]
</pre>

<p>
然后我试着将root变量的数据结构简单表示（显然元素是一个类结构，这里只是简单将其名字提出来，属性作为字典加进去。）如下：
</p>
<pre>
root[head[meta[{'charset': 'utf-8'}],
    link[{'rel':'stylesheet', 'href':'main.css'}], ...]
</pre>
</div>
</div>

<div class="outline-2">
<h2 id="orgheadline5">往里面加入内容</h2>
<div class="outline-text-2" id="text-3">
<p>
一般没有必要完全从零开始新建一个xml文档了，继续上面的讨论我们用 <strong>parse</strong> 函数接受一个html文档模板之后，然后往里面加入一些内容或者做出一些修改，然后将其保存到一个新的文件即完成了一个新的html文档创建过程。
</p>

<p>
如下所示: 
</p>
<pre>
with open(filename,'w') as html:
    ......
    bstring = etree.tostring(tree)
    string  = bstring.decode('utf-8')
    print(string,file=html)
</pre>

<p>
这里值得一提的在python3.4下（lxml version:3.3.3）， <strong>tostring</strong> 是输出的bytes类型，需要将其decode成为字符串才行。
</p>
</div>

<div class="outline-3">
<h3 id="orgheadline3">Element类</h3>
<div class="outline-text-3" id="text-3-1">
<p>
前面提到每一个元素都是一个类，其是通过 <strong>Element</strong> 类初始化函数来创建的。
</p>
<div class="highlight"><pre><span></span><span class="n">title</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span>
</pre></div>

<p>
这样对应的是&lt;aside /&gt;，这个元素已经有tag属性了，但还没有其他字典属性或text属性，所以是一个简单的闭括号结构。之前谈到你可以通过 <code>title.text</code> 来索引该闭括号所包含的文本，同样你可以如此赋值修改：
</p>
<div class="highlight"><pre><span></span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;your awesome title&quot;</span>
</pre></div>

<p>
现在你可以用 <strong>etree.tostring</strong> 函数查看一下这个title对象成什么样子了，大致如下：
</p>
<pre>
b'&lt;title&gt;your awesome title&lt;/title&gt;'
</pre>

<p>
类似的应该也可以通过 <code>title.attrib</code> 来设置元素的字典属性，不过推荐使用元素的 <strong>set</strong> 方法：
</p>
<div class="highlight"><pre><span></span><span class="n">title</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">,</span><span class="s2">&quot;color:red;&quot;</span><span class="p">)</span>
</pre></div>

<p>
现在title变成这样了：
</p>
<pre>
&gt;&gt;&gt; etree.tostring(title)
b'&lt;title style="color:red;"&gt;your awesome title&lt;/title&gt;'
</pre>


<p>
在创建元素的时候你可以如下所示更快捷地加入某些字典属性：
</p>
<pre>
&gt;&gt;&gt; a = etree.Element("a",href="index.html")
&gt;&gt;&gt; etree.tostring(a)
b'&lt;a href="index.html"/&gt;'
</pre>

<p>
不过似乎text属性并不能这样做。
</p>
</div>
</div>

<div class="outline-3">
<h3 id="orgheadline4">SubElement类</h3>
<div class="outline-text-3" id="text-3-2">
<p>
SubElement类和Element类很类似，除了其初始化函数第一个参数必须指明父元素是谁，然后后面的参数都和Element类一样，再必填一个tag属性。
</p>
<pre>
SubElement(_parent, _tag, attrib=None)
</pre>

<p>
那么我们必须需要依靠SubElement类的初始化函数来指定html文档中元素的父子继承关系吗？一般情况没必要这么。在平行级别下，就是常规的列表append和insert操作处理各个子元素之间的关系，然后你可以通过给具体的某个父元素命名，然后将某个子元素append或者insert进这个父元素列表中，即指明了其父子关系。而前面的SubElement说白了也只是一个简单的append操作罢了。SubElement类相当于一个高级封装，集大成者，有时很便捷，有时会很不灵活，看读者的使用喜好了。
</p>
</div>
</div>
</div>





<div class="outline-2">
<h2 id="orgheadline6">参考资料</h2>
<div class="outline-text-2" id="text-4">
<ol class="org-ol">
<li><a href="http://infohost.nmt.edu/tcc/help/pubs/pylxml/web/index.html">python xml processing with lxml</a> <a id="orgtarget1"></a></li>
<li><a href="http://zh.wikipedia.org/zh/XML">xml维基</a> <a id="orgtarget2"></a></li>
</ol>
</div>
</div>
</div>
</body>
</html>
